# v0.7 Push Notifications - Deployment Checklist

Use this checklist to deploy v0.7 Push Notifications to production.

## ‚úÖ Pre-Deployment (Development Complete)

- [x] Database migrations created
- [x] Database migrations applied to production
- [x] TypeScript types generated
- [x] Frontend components created
- [x] Backend Edge Function created
- [x] Service worker implemented
- [x] PWA manifest created
- [x] Documentation written
- [x] CHANGELOG updated
- [x] Project context updated

## üîß Manual Setup Required

### 1. Generate VAPID Keys
- [ ] Run: `npx web-push generate-vapid-keys`
- [ ] Copy public key (starts with 'B')
- [ ] Copy private key
- [ ] Store keys securely (password manager)

### 2. Configure Environment Variables
- [ ] Add to `.env.local`:
  ```
  NEXT_PUBLIC_VAPID_PUBLIC_KEY=your_public_key
  VAPID_PRIVATE_KEY=your_private_key
  ```
- [ ] Verify `.env.local` is in `.gitignore`
- [ ] Test locally: `npm run dev`

### 3. Deploy to Vercel
- [ ] Commit changes: `git add . && git commit -m "feat: v0.7 push notifications"`
- [ ] Push to GitHub: `git push`
- [ ] Wait for Vercel deployment
- [ ] Add environment variables in Vercel dashboard:
  - `NEXT_PUBLIC_VAPID_PUBLIC_KEY`
  - `VAPID_PRIVATE_KEY`
- [ ] Redeploy if needed

### 4. Deploy Edge Function
- [ ] Set Supabase secrets:
  ```bash
  supabase secrets set VAPID_PUBLIC_KEY=your_public_key --project-ref eoywypjbilsedasmytsu
  supabase secrets set VAPID_PRIVATE_KEY=your_private_key --project-ref eoywypjbilsedasmytsu
  ```
- [ ] Deploy function:
  ```bash
  supabase functions deploy schedule-notifications --project-ref eoywypjbilsedasmytsu
  ```
- [ ] Verify deployment:
  ```bash
  supabase functions list --project-ref eoywypjbilsedasmytsu
  ```

### 5. Set Up Cron Job
- [ ] Go to Supabase Dashboard > Database > Extensions
- [ ] Enable `pg_cron` extension
- [ ] Go to SQL Editor
- [ ] Run cron setup SQL (see `docs/NOTIFICATIONS_SETUP.md`)
- [ ] Verify cron job created:
  ```sql
  SELECT * FROM cron.job;
  ```

### 6. Create App Icons
- [ ] Design 192x192px icon (`/public/icon-192.png`)
- [ ] Design 512x512px icon (`/public/icon-512.png`)
- [ ] Design 72x72px badge (`/public/badge-72.png`)
- [ ] Use heart symbol with red (#ef4444) theme
- [ ] Optimize images (TinyPNG)
- [ ] Upload to `/public/` folder
- [ ] Commit and deploy

## üß™ Testing

### Browser Testing
- [ ] Test on Chrome Desktop
- [ ] Test on Chrome Android
- [ ] Test on Firefox Desktop
- [ ] Test on Safari macOS (if available)
- [ ] Test on Safari iOS 16.4+ (if available)

### Functionality Testing
- [ ] Open app in browser (HTTPS)
- [ ] See notification banner on dashboard
- [ ] Click "Enable Notifications"
- [ ] Grant permission when prompted
- [ ] Verify subscription saved in database:
  ```sql
  SELECT * FROM push_subscriptions WHERE user_id = 'your_user_id';
  ```
- [ ] Go to Settings > Notifications
- [ ] Verify all settings load correctly
- [ ] Change preferences and save
- [ ] Verify preferences saved in database:
  ```sql
  SELECT * FROM health_notification_preferences WHERE user_id = 'your_user_id';
  ```

### Notification Testing
- [ ] Create test vaccination with due date in 3 days
- [ ] Manually trigger Edge Function:
  ```bash
  curl -X POST https://eoywypjbilsedasmytsu.supabase.co/functions/v1/schedule-notifications \
    -H "Authorization: Bearer YOUR_ANON_KEY"
  ```
- [ ] Check Edge Function logs:
  ```bash
  supabase functions logs schedule-notifications --project-ref eoywypjbilsedasmytsu
  ```
- [ ] Verify notification appears on device
- [ ] Click notification and verify navigation
- [ ] Check notification log in database:
  ```sql
  SELECT * FROM notification_logs ORDER BY sent_at DESC LIMIT 10;
  ```

### Multi-Device Testing
- [ ] Subscribe on second device
- [ ] Verify both subscriptions in database
- [ ] Trigger notification
- [ ] Verify notification appears on both devices

### Quiet Hours Testing
- [ ] Set quiet hours to current time
- [ ] Trigger notification
- [ ] Verify notification NOT sent during quiet hours
- [ ] Change quiet hours to exclude current time
- [ ] Trigger notification
- [ ] Verify notification IS sent

## üìä Monitoring

### Initial Monitoring (First Week)
- [ ] Check notification success rate daily:
  ```sql
  SELECT 
    notification_type,
    COUNT(*) as total,
    SUM(CASE WHEN status = 'sent' THEN 1 ELSE 0 END) as sent,
    SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed
  FROM notification_logs
  WHERE sent_at >= NOW() - INTERVAL '24 hours'
  GROUP BY notification_type;
  ```
- [ ] Check Edge Function invocation count
- [ ] Check for errors in Edge Function logs
- [ ] Monitor database query performance
- [ ] Check user feedback

### Ongoing Monitoring (Weekly)
- [ ] Review notification engagement:
  ```sql
  SELECT 
    notification_type,
    COUNT(*) as sent,
    SUM(CASE WHEN clicked_at IS NOT NULL THEN 1 ELSE 0 END) as clicked,
    ROUND(100.0 * SUM(CASE WHEN clicked_at IS NOT NULL THEN 1 ELSE 0 END) / COUNT(*), 2) as click_rate
  FROM notification_logs
  WHERE sent_at >= NOW() - INTERVAL '7 days'
  GROUP BY notification_type;
  ```
- [ ] Review active subscriptions:
  ```sql
  SELECT COUNT(*) as active_subscriptions FROM push_subscriptions WHERE is_active = TRUE;
  ```
- [ ] Check for failed notifications and investigate
- [ ] Review user preferences adoption rate

## üêõ Troubleshooting

### Notifications Not Appearing
- [ ] Check browser console for errors
- [ ] Verify service worker registered: `navigator.serviceWorker.controller`
- [ ] Check notification permission: `Notification.permission`
- [ ] Verify subscription exists in database
- [ ] Check `notification_logs` for errors
- [ ] Verify VAPID keys are correct

### Edge Function Errors
- [ ] Check function logs: `supabase functions logs schedule-notifications`
- [ ] Verify environment variables set
- [ ] Test function locally: `supabase functions serve`
- [ ] Check database permissions and RLS policies
- [ ] Verify cron job is running

### Service Worker Issues
- [ ] Ensure HTTPS (required for service workers)
- [ ] Check `/sw.js` is accessible
- [ ] Clear browser cache and reload
- [ ] Check browser console for registration errors
- [ ] Verify service worker scope is correct

## üìù Post-Deployment

### Documentation
- [ ] Update internal wiki/docs with setup instructions
- [ ] Share deployment notes with team
- [ ] Document any issues encountered and solutions

### User Communication
- [ ] Announce new feature to users
- [ ] Provide instructions for enabling notifications
- [ ] Explain benefits (never miss vaccinations, medications, appointments)
- [ ] Highlight privacy (data never leaves family, can disable anytime)

### Feedback Collection
- [ ] Set up feedback mechanism (form, email, etc.)
- [ ] Monitor user adoption rate
- [ ] Collect feedback on notification timing
- [ ] Collect feedback on notification frequency
- [ ] Identify most useful notification types

## üéØ Success Criteria

- [ ] 80%+ notification delivery success rate
- [ ] <5% failed notifications
- [ ] 50%+ users enable notifications within first week
- [ ] 20%+ notification click-through rate
- [ ] Zero critical errors in Edge Function
- [ ] Positive user feedback

## üìÖ Timeline

- **Day 1**: Complete manual setup (VAPID keys, Edge Function, cron)
- **Day 2**: Create app icons and deploy
- **Day 3-7**: Monitor closely, fix any issues
- **Week 2**: Review metrics, gather feedback
- **Week 3**: Optimize based on feedback
- **Week 4**: Consider enhancements (notification actions, history view)

## üöÄ Next Steps After Deployment

1. Monitor notification performance for 1 week
2. Gather user feedback
3. Optimize notification timing based on engagement
4. Consider adding notification actions (snooze, mark done)
5. Add notification history view
6. Implement health insights notifications
7. Add notification preferences per family member

---

**Deployment Date**: _____________  
**Deployed By**: _____________  
**Issues Encountered**: _____________  
**Notes**: _____________
